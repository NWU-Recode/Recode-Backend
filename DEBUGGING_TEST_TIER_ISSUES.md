# üêõ DEBUGGING TEST CASE & TIER PERSISTENCE ISSUES

## Issue 1: Test Cases Not Saving ‚ùå

### Root Cause Investigation:

The test persistence code is comprehensive with multiple fallbacks, BUT:

1. Tests may not be generated by the model correctly
2. The `_insert_testcase()` function is nested and async - may have scoping issues
3. Error logging only happens when `GENERATOR_DEBUG=1` is set

### Potential Problems:

```python
# Line ~1047-1050: This nested async function might have issues
async def _insert_testcase() -> bool:
    """Try inserting a testcase handling schema variants..."""
    use_expected_output = await _supports_expected_output()
    # ... tries to insert but errors are swallowed unless DEBUG=1
```

**The problem**: If any exception occurs during test insertion, it's caught and silently logged only when DEBUG mode is on. The function returns `False` but doesn't raise errors.

### Fix Strategy:

1. Enable debug logging permanently for test insertion
2. Add error tracking to see how many tests fail vs succeed
3. Make sure tier is properly set for challenges

---

## Issue 2: Tier Not Being Saved ‚ùå

### Root Cause FOUND:

**Location**: `app/features/challenges/challenge_pack_generator.py` lines 788-793

```python
# CURRENT CODE (WRONG):
if is_weekly:
    payload["week_number"] = effective_week
    # Do not explicitly set the `tier` enum for weekly challenges
    pass
else:
    # Do not set the `tier` enum value explicitly
    # ... tier is NOT being set!
```

**The problem**: The code explicitly avoids setting the `tier` field! This was done to handle different enum variants across deployments, but it means tier is NULL in the database.

### Fix Strategy:

Add tier to the payload for BOTH weekly and special challenges:

```python
if is_weekly:
    payload["week_number"] = effective_week
    payload["tier"] = "base"  # ADD THIS
else:
    payload["week_number"] = effective_week
    payload["tier"] = tier  # ADD THIS (ruby/emerald/diamond)
```

---

## üîß FIXES TO IMPLEMENT

### Fix 1: Always Set Tier in Challenge Payload

**File**: `app/features/challenges/challenge_pack_generator.py`  
**Line**: ~785-795

**BEFORE**:

```python
if is_weekly:
    payload["week_number"] = effective_week
    # Do not explicitly set the `tier` enum for weekly challenges
    pass
else:
    # Do not set the `tier` enum value explicitly
    if tier == "diamond":
        payload["week_number"] = 12
    else:
        payload["week_number"] = effective_week
```

**AFTER**:

```python
if is_weekly:
    payload["week_number"] = effective_week
    payload["tier"] = "base"  # Always set tier for weekly challenges
else:
    payload["tier"] = tier  # Set tier to ruby/emerald/diamond
    if tier == "diamond":
        payload["week_number"] = 12
    else:
        payload["week_number"] = effective_week
```

---

### Fix 2: Improve Test Case Error Logging

**File**: `app/features/challenges/challenge_pack_generator.py`  
**Line**: ~1060-1150

**Add permanent logging for test insertion failures**:

```python
# Instead of only logging when _debug=True, ALWAYS log test failures
if not success:
    logger.error(f"Failed to persist test case for question {qid}: input={base_input[:50]}, expected={expected_val[:50]}")
```

---

### Fix 3: Add Test Persistence Summary to Challenge Generation

**File**: `app/features/challenges/challenge_pack_generator.py`  
**Line**: After test insertion loop (~1155)

**Add summary logging**:

```python
# After all tests processed, log summary
if tests:
    logger.info(f"Question {qid}: Persisted {persisted_count}/{len(tests)} test cases")
    if persisted_count < len(tests):
        logger.warning(f"Question {qid}: {len(tests) - persisted_count} test cases failed to persist!")
```

---

## üß™ TESTING AFTER FIXES

### 1. Enable Debug Mode

```bash
export GENERATOR_DEBUG=1  # or set in .env
```

### 2. Run Challenge Generation

```bash
# Generate a test challenge
POST /api/challenges/generate
{
  "tier": "ruby",
  "week": 2,
  "module_code": "COMP101"
}
```

### 3. Check Logs

Look for:

- `"challenge payload prepared"` - should show `"tier": "ruby"`
- `"questions.insert response"` - should show question inserted
- `"Primary insert failed"` or `"Secondary insert failed"` - test insertion attempts
- `"Inserted testcase into legacy tests table"` - fallback attempts
- `"Question X: Persisted Y/Z test cases"` - summary

### 4. Verify Database

```sql
-- Check challenge has tier
SELECT id, week_number, challenge_type, tier, title
FROM challenges
WHERE week_number = 2 AND module_code = 'COMP101'
ORDER BY created_at DESC;
-- Expected: tier = 'base' for weekly, 'ruby'/'emerald'/'diamond' for special

-- Check questions have test cases
SELECT q.id, q.title, q.challenge_id, COUNT(qt.id) as test_count
FROM questions q
LEFT JOIN question_tests qt ON qt.question_id = q.id
WHERE q.challenge_id IN (
    SELECT id FROM challenges WHERE week_number = 2 AND module_code = 'COMP101'
)
GROUP BY q.id, q.title, q.challenge_id;
-- Expected: Each question should have at least 3 tests
```

---

## üéØ EXPECTED RESULTS

After fixes:

- ‚úÖ Challenges have `tier` field populated: "base", "ruby", "emerald", or "diamond"
- ‚úÖ All questions have minimum 3 test cases in `question_tests` table
- ‚úÖ Logs show test insertion success/failure details
- ‚úÖ No silent failures

---

## üìä CURRENT VS EXPECTED DATABASE STATE

### BEFORE FIX:

```sql
challenges:
  id | tier  | week_number | challenge_type
  ---+-------+-------------+---------------
  1  | NULL  | 2           | weekly        ‚ùå tier is NULL
  2  | NULL  | 2           | special       ‚ùå tier is NULL

question_tests:
  [potentially 0 rows if tests failed silently] ‚ùå
```

### AFTER FIX:

```sql
challenges:
  id | tier    | week_number | challenge_type
  ---+---------+-------------+---------------
  1  | base    | 2           | weekly        ‚úÖ
  2  | ruby    | 2           | special       ‚úÖ

question_tests:
  question_id | input      | expected   | visibility
  ------------+------------+------------+-----------
  1           | "test1"    | "output1"  | public    ‚úÖ
  1           | "test2"    | "output2"  | private   ‚úÖ
  1           | "test3"    | "output3"  | private   ‚úÖ
  ... (minimum 3 per question)
```
